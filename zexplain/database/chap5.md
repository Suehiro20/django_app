# データベース
Django対応のデータベースは以下の通り  

|データベース|説明|
|---|---|
|MySQL|オープンソースのデータベース（おそらく、最も広く使われているそうです）|
|PostgreSQL|Linuxなどで広く使われている（おそらく、日本で最も人気が高いそうです）|
|SQLite|データベースファイルに直接アクセスするタイプのもので、非常に小さい。スマホなどでも内部に使っている|

Djangoは**SQLite**が標準で組み込まれている

これらの共通点は、「SQLというデータアクセス言語を使用している点」  

## サーバーとエンジン
データベースのプログラムには大きく分けて2つのタイプ

* サーバータイプ  
データベースにアクセスする専用のサーバープログラムを起動し、Webサーバーとデータベースサーバーの間で通信してデータのやり取りを行う  
MySQLとPostgreSQLは「データベースサーバー」  

* エンジンタイプ  
データベースファイルに直接アクセスするエンジンプログラム  
クラウドサービス（プログラムを丸ごと実行できる）では、プログラムサイズが小さくて負担にならないこちらの方が使いやすい  
SQLiteですね  

## データベースの設定
SQliteのプログラムは組み込まれているが、何もせずに使えるわけではない（というが、いじる必要はないと思います）  
`settings.py`で設定を行う  

### 内容
`DATABASES`と書いてある箇所をチェック  
おそらくいじる必要はない？

私の場合  
```py
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
```

書籍やネットでよく見かけるのは以下  
```py
import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}
```

#### SQLite
```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, db.sqlite3'),
    }
}
```

* `'ENGINE'`  
データベースへのアクセスに使われるプログラム。sqliteの場合は、「django.db.backends.sqlite3」というクラスを使う。  

* `'NAME'`  
利用するデータベースの名前。sqliteの場合、データベースファイルのパスを設定する。  
`os.path.join`は、2つのパスをつなぎ合わせて1つのパスにするもの。  
`BASE_DIR`は、このプロジェクトのフォルダのパスが設定された変数。  
`os.path.join(BASE_DIR, db.sqlite3')`で「プロジェクトのフォルダ内にある`db.sqlite3`のパス」を表す。  

#### MySQL
```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': データベース名,
        'USER': 利用者名,
        'PASSWORD': パスワード,
        'HOST': ホスト名,
        'PORT': '3306',
    }
}
```

`'HOST'`には、データベースサーバーが動いているホストコンピュータのアドレスとポート番号を用意する。  
データベースサーバーにアクセスする際に使用する利用者名とパスワードも用意する。  

#### PostgreSQL
```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': データベース名,
        'USER': 利用者名,
        'PASSWORD': パスワード,
        'HOST': ホスト名,
        'PORT': '5432',
    }
}
```

## データベースの構造
「データベース」「テーブル」「レコード」により構成  

* データベース  
一番の土台。  
直接ファイルにアクセスするタイプは、データベースのファイルがこれに当たる。  
サーバータイプのものは、それぞれのアプリケーションごとに、サーバーにデータベースを用意する。  
データベースの中には、データは保存できない。データベースは「テーブル」をまとめて入れるためのもの。  

* テーブル  
保存するデータの構造を定義する。  
「テキストの値の名前、メアド、年齢の整数値、、、」といった具合に、どういう値を用意するのかを詳しく指定する。  
実際にデータを保管する入れ物になる。  

* レコード  
テーブルの中に保管されるデータのこと。  
「名前・メアド・年齢・電話番号・住所」といった項目を持つテーブルがあったら、そこに保存するレコードも、これらの値一式をソロいたものでなければならない。（空OKとすることもできる）  

## テーブルの設計
「このアプリではどういったテーブルが必要か」を考え、それをもとに設計する。  
「何の値か」だけでなく「どういう種類の値か」も考える。  

e.g.  
|項目|内容|
|名前|名前を保管する。テキストの値。|
|メアド|メアドを保管する。テキストの値。|
|性別|性別を表す真偽値。「Falseなら男、Trueなら女、Unknownなら回答しない」など。|
|年齢|年齢を保管する。整数値。|
|誕生日|誕生日の年月日を保管する。日付の値。|

## モデルの作成
Djangoはデータベースにテーブルを作っておく必要がない！  
プロジェクトにデータベース関係のコードを書いておけば、それを元にデータベースにテーブルを自動生成できる。  
→ テーブル設計ができたら「Djangoのプロジェクトに、テーブルの内容を書いておく」作業  

「モデル＝テーブルの定義」  
モデルは利用するテーブルごとに作成される。テーブルにどんな値を保管するどんな項目があるのか、を定義する。  

「モデルのインスタンス＝テーブルのレコード」
そのテーブルのレコードは、Djangoでは対応するモデルのインスタンスとして扱われる。  

<!-- JavaScriptで考えると、  

* モデル＝type定義
* レコード＝変数

かな？  
```ts
interface BackPack {
  content: string[];
  color: string;
}

const fruitPack: BackPack = {
  content: ['orange', 'banana', 'banana'],
  color: 'blue',
}
``` -->

### models.py
各アプリケーションフォルダに存在。  

```py
from django.db import models

class Friend(models.Model):
    変数 = フィールドのインスタンス

    def __str__(self):
        return '<Friend: id=' + str(self.id) + ', ' + \
            self.name + '( ' + str(self.age) + ' )>'
```

「\_\_str__」は、「テキストの値」を返すためのもの。  
Friendクラスのインスタンスを{{}}で表示させると、この「\_\_str__」でreturnされたテキストが表示される。  

### migration
データベースの移行を行うために機能。  
あるデータベースから別のデータベースに移行するとき、必要なテーブルを作成したりしてスムーズに移行できるようにする。  

他のデータベースへの移行だけでなく、プロジェクトでデータベースをアップデートするのにも使われる。  
→ 今回のように「データベースに何もない状態から、モデルをもとに必要なテーブルを作成する」とき  

手順は以下  

* マイグレーションファイルの作成
* マイグレーションファイルの適用

#### マイグレーションファイルの作成
ターミナルで行う  
プロジェクトのディレクトリにいること・仮想環境を動かしていることを確認して以下を実行  
`python manage.py makemigrations アプリケーション名`  

#### マイグレーションの実行
作成したマイグレーションファイルを適用してデータベースを更新する処理  
プロジェクトのディレクトリにいること・仮想環境を動かしていることを確認して以下を実行  
`python manage.py migrate`

#### 補足
マイグレーションを実行すると、アプリケーションフォルダ内に「migrationsフォルダ」が作成される。  
「0001_initial.py」が作成されているはず。  
これをもとに、モデルのテーブルが作られる。
